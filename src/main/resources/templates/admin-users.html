<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Manage Users</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" th:href="@{/css/admin.css}">
  <link rel="stylesheet" th:href="@{/css/components.css}">
</head>
<body>
  <div th:insert="fragments/navbar :: navbar"></div>

  <div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h1>Users</h1>
      <div>
        <button class="btn btn-primary" id="addUserBtn">Add User</button>
      </div>
    </div>

    <table class="table table-striped">
      <thead>
        <tr>
          <th>ID</th>
          <th>Name</th>
          <th>Email</th>
          <th>Role</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="usersBody">
        <tr th:if="${users != null and !users.isEmpty()}" th:each="user : ${users}">
          <td th:text="${user.id}">1</td>
          <td th:text="${user.firstName + ' ' + user.lastName}">John Doe</td>
          <td th:text="${user.email}">john@example.com</td>
          <td>
            <span th:if="${user.role.name() == 'ADMIN'}" class="badge bg-danger">Admin</span>
            <span th:if="${user.role.name() == 'CUSTOMER'}" class="badge bg-primary">Customer</span>
          </td>
          <td>
            <button class="btn btn-sm btn-primary edit-user-btn" th:data-user-id="${user.id}">Edit</button>
            <button class="btn btn-sm btn-danger delete-user-btn" th:data-user-id="${user.id}">Delete</button>
          </td>
        </tr>
        <tr th:if="${users == null or users.isEmpty()}">
          <td colspan="5" class="text-center">
            <div class="alert alert-info mb-0">No users found</div>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <div class="modal fade" id="editUserModal" tabindex="-1" aria-labelledby="editUserModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="editUserModalLabel">Edit User</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="editUserForm">
            <input type="hidden" id="editUserId">
            <div class="mb-3">
              <label for="editFirstName" class="form-label">First Name</label>
              <input type="text" class="form-control" id="editFirstName" required>
            </div>
            <div class="mb-3">
              <label for="editLastName" class="form-label">Last Name</label>
              <input type="text" class="form-control" id="editLastName" required>
            </div>
            <div class="mb-3">
              <label for="editEmail" class="form-label">Email</label>
              <input type="email" class="form-control" id="editEmail" required>
            </div>
            <div class="mb-3">
              <label for="editPhone" class="form-label">Phone Number</label>
              <input type="tel" class="form-control" id="editPhone" required>
            </div>
            <div class="mb-3">
              <label for="editRole" class="form-label">Role</label>
              <select class="form-select" id="editRole" required>
                <option value="ADMIN">Admin</option>
                <option value="CUSTOMER">Customer</option>
                <option value="SELLER">Seller</option>
              </select>
            </div>
            <div class="mb-3">
              <label for="editPassword" class="form-label">Password (leave blank to keep current)</label>
              <input type="password" class="form-control" id="editPassword">
            </div>
            <div class="mb-3 form-check">
              <input type="checkbox" class="form-check-input" id="editEnabled">
              <label class="form-check-label" for="editEnabled">Account Enabled</label>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-primary" id="saveUserBtn">Save Changes</button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="addUserModal" tabindex="-1" aria-labelledby="addUserModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="addUserModalLabel">Add User</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="addUserForm">
            <div class="mb-3">
              <label for="addFirstName" class="form-label">First Name</label>
              <input type="text" class="form-control" id="addFirstName" required>
            </div>
            <div class="mb-3">
              <label for="addLastName" class="form-label">Last Name</label>
              <input type="text" class="form-control" id="addLastName" required>
            </div>
            <div class="mb-3">
              <label for="addEmail" class="form-label">Email</label>
              <input type="email" class="form-control" id="addEmail" required>
            </div>
            <div class="mb-3">
              <label for="addPhone" class="form-label">Phone Number</label>
              <input type="tel" class="form-control" id="addPhone" required>
            </div>
            <div class="mb-3">
              <label for="addRole" class="form-label">Role</label>
              <select class="form-select" id="addRole" required>
                <option value="ADMIN">Admin</option>
                <option value="CUSTOMER" selected>Customer</option>
                <option value="SELLER">Seller</option>
              </select>
            </div>
            <div class="mb-3">
              <label for="addPassword" class="form-label">Password</label>
              <input type="password" class="form-control" id="addPassword" required>
            </div>
            <div class="mb-3 form-check">
              <input type="checkbox" class="form-check-input" id="addEnabled" checked>
              <label class="form-check-label" for="addEnabled">Account Enabled</label>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-primary" id="createUserBtn">Create User</button>
        </div>
      </div>
    </div>
  </div>

  <div th:insert="fragments/footer :: footer"></div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script th:src="@{/js/utils.js}"></script>
  <script th:src="@{/js/api.js}"></script>
  <script th:src="@{/js/notifications.js}"></script>
  <script th:src="@{/js/admin.js}"></script>
  <script>
    document.getElementById('addUserBtn').addEventListener('click', function() {
      const modal = new bootstrap.Modal(document.getElementById('addUserModal'));
      document.getElementById('addUserForm').reset();
      document.getElementById('addEnabled').checked = true;
      modal.show();
    });

    document.getElementById('createUserBtn').addEventListener('click', async function() {
      const payload = {
        firstName: document.getElementById('addFirstName').value,
        lastName: document.getElementById('addLastName').value,
        email: document.getElementById('addEmail').value,
        phoneNumber: document.getElementById('addPhone').value,
        role: document.getElementById('addRole').value,
        password: document.getElementById('addPassword').value,
        enabled: document.getElementById('addEnabled').checked
      };

      try {
        const res = await fetch('/api/admin/users', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        if (!res.ok) throw new Error('Failed to create user');
        alert('User created successfully');
        location.reload();
      } catch (e) {
        alert('Error creating user: ' + e.message);
      }
    });

    document.querySelectorAll('.edit-user-btn').forEach(btn => {
      btn.addEventListener('click', async function() {
        const userId = this.getAttribute('data-user-id');
        
        try {
          const response = await fetch(`/api/admin/users/${userId}`);
          if (!response.ok) throw new Error('Failed to fetch user');
          
          const user = await response.json();
          
          document.getElementById('editUserId').value = user.id;
          document.getElementById('editFirstName').value = user.firstName;
          document.getElementById('editLastName').value = user.lastName;
          document.getElementById('editEmail').value = user.email;
          document.getElementById('editPhone').value = user.phoneNumber;
          document.getElementById('editRole').value = user.role;
          document.getElementById('editEnabled').checked = user.enabled;
          document.getElementById('editPassword').value = '';
          
          const modal = new bootstrap.Modal(document.getElementById('editUserModal'));
          modal.show();
        } catch (error) {
          alert('Error loading user data: ' + error.message);
        }
      });
    });

    document.getElementById('saveUserBtn').addEventListener('click', async function() {
      const userId = document.getElementById('editUserId').value;
      const userData = {
        firstName: document.getElementById('editFirstName').value,
        lastName: document.getElementById('editLastName').value,
        email: document.getElementById('editEmail').value,
        phoneNumber: document.getElementById('editPhone').value,
        role: document.getElementById('editRole').value,
        enabled: document.getElementById('editEnabled').checked,
        password: document.getElementById('editPassword').value
      };

      try {
        const response = await fetch(`/api/admin/users/${userId}`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(userData)
        });

        if (!response.ok) throw new Error('Failed to update user');

        alert('User updated successfully!');
        location.reload();
      } catch (error) {
        alert('Error updating user: ' + error.message);
      }
    });

    document.querySelectorAll('.delete-user-btn').forEach(btn => {
      btn.addEventListener('click', async function() {
        const userId = this.getAttribute('data-user-id');
        
        if (!confirm('Are you sure you want to delete this user? This action cannot be undone.')) {
          return;
        }

        try {
          const response = await fetch(`/api/admin/users/${userId}`, {
            method: 'DELETE'
          });

          if (!response.ok) throw new Error('Failed to delete user');

          alert('User deleted successfully!');
          location.reload();
        } catch (error) {
          alert('Error deleting user: ' + error.message);
        }
      });
    });
  </script>
</body>
</html>